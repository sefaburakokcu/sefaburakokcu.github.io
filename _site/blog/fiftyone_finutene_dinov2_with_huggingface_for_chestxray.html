<!DOCTYPE html>

<!--
  portfolYOU Jekyll theme by Youssef Raafat
  Free for personal and commercial use under the MIT license
  https://github.com/YoussefRaafatNasry/portfolYOU
-->

<html lang="en" class="h-100">

<head>

  
  
  

  

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:type" content="website">
  <meta property="og:title" content="FiftyOne Finetune DinoV2 for ChestXray Dataset">
  <meta property="og:description" content="Hi, I'm Sefa Burak OKCU. I'm working as a Deep Learning Engineer. I've completed Master of Science in Cognitive Science recently.">
  <meta property="og:image" content="/assets/avatar.jpeg">

  <title>FiftyOne Finetune DinoV2 for ChestXray Dataset</title>
  <meta name="description" content="Hi, I'm Sefa Burak OKCU. I'm working as a Deep Learning Engineer. I've completed Master of Science in Cognitive Science recently.">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/favicon.ico">

  <!-- Theme style -->
  <script src="/assets/js/theme.js"></script>

  <!-- Font Awesome CDN -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css">

  <!-- Bootstrap CSS CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">

  <!-- Animate CSS CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.css">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/assets/css/style.css">

</head>


<body class="h-100 d-flex flex-column">

  <main class="flex-shrink-0 container mt-5">
    <nav class="navbar navbar-expand-lg navbar-themed">

  <a class="navbar-brand" href="/"><h5><b>Sefa Burak OKCU</b></h5></a>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
    <i class="fas fa-1x fa-bars text-themed"></i>
  </button>

  <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
    <div class="navbar-nav ml-auto"><a class="nav-item nav-link " href="/projects/">Projects</a>

      <a class="nav-item nav-link active" href="/blog/">Blog</a>

      <a class="nav-item nav-link " href="/pages/publications">Publications</a>

      <a class="nav-item nav-link " href="/about/">About</a>

      

      <span id="theme-toggler" class="nav-item nav-link" role="button" onclick="toggleTheme()"></span>
    </div>
  </div>

</nav>
    <div class="col-lg-10 mx-auto mt-5 markdown-body">
  <h1><b>FiftyOne Finetune DinoV2 for ChestXray Dataset</b></h1>

<p class="post-metadata text-muted">
  13 January 2024 -  
  <b>12 mins read time</b>

  <br>Tags: 
    
    <a class="text-decoration-none no-underline" href="/blog/tags#python">
      <span class="tag badge badge-pill text-primary border border-primary">python</span>
    </a>
    
    <a class="text-decoration-none no-underline" href="/blog/tags#pytorch">
      <span class="tag badge badge-pill text-primary border border-primary">pytorch</span>
    </a>
    
    <a class="text-decoration-none no-underline" href="/blog/tags#fiftyone">
      <span class="tag badge badge-pill text-primary border border-primary">fiftyone</span>
    </a>
    
    <a class="text-decoration-none no-underline" href="/blog/tags#huggingface">
      <span class="tag badge badge-pill text-primary border border-primary">huggingface</span>
    </a>
    
    <a class="text-decoration-none no-underline" href="/blog/tags#dinov2">
      <span class="tag badge badge-pill text-primary border border-primary">dinov2</span>
    </a>
    </p>

<h2 id="introduction">Introduction</h2>

<p>In this tutorial, we will:</p>

<ul>
  <li>Examine the ChestXray dataset using FiftyOne,</li>
  <li>Finetune a Dinov2 model from HuggingFace Transformers on the ChestXray dataset, which has 2 classes,</li>
  <li>Evaluate the finetuned model on the validation subset,</li>
  <li>Compare predictions and ground truths using FiftyOne.</li>
</ul>

<p>Let’s start by installing the required libraries.</p>

<h2 id="setup">Setup</h2>

<p>Firstly, install HuggingFace datasets, transformers and FiftyOne.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># !pip install datasets transformers --upgrade
</span></code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># !pip install fiftyone 
</span></code></pre></div></div>

<h2 id="dataset">Dataset</h2>

<p>Now, let’s download the dataset.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tqdm</span>
<span class="kn">import</span> <span class="nn">fiftyone</span> <span class="k">as</span> <span class="n">fo</span>

<span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">load_dataset</span>

<span class="n">dataset_root</span> <span class="o">=</span> <span class="s">"./datasets"</span>
<span class="n">dataset_splits</span> <span class="o">=</span> <span class="p">[</span><span class="s">"train"</span><span class="p">,</span> <span class="s">"validation"</span><span class="p">,</span> <span class="s">"test"</span><span class="p">]</span>

<span class="n">dataset_name</span> <span class="o">=</span> <span class="s">"trpakov/chest-xray-classification"</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">"full"</span><span class="p">)</span>

<span class="n">class_names</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s">"train"</span><span class="p">].</span><span class="n">features</span><span class="p">[</span><span class="s">"labels"</span><span class="p">].</span><span class="n">names</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">class_names</span>

<span class="n">id2label</span> <span class="o">=</span> <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">)}</span>
<span class="n">label2id</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">):</span> <span class="nb">id</span> <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">)}</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"id2label: </span><span class="si">{</span><span class="n">id2label</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="k">for</span> <span class="n">dataset_split</span> <span class="ow">in</span> <span class="n">dataset_splits</span><span class="p">:</span>
    <span class="n">dataset_save_folder</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset_root</span><span class="p">,</span> <span class="n">dataset_split</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dataset_save_folder</span><span class="p">):</span>
        <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dataset_save_folder</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">image_idx</span><span class="p">,</span> <span class="n">image_cl_dict</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">.</span><span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">dataset_split</span><span class="p">]),</span>
                                                  <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">dataset_split</span><span class="p">]),</span>
                                                  <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s">"Saving </span><span class="si">{</span><span class="n">dataset_split</span><span class="si">}</span><span class="s"> images"</span><span class="p">):</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">image_cl_dict</span><span class="p">[</span><span class="s">"image"</span><span class="p">]</span>
            <span class="n">cls</span> <span class="o">=</span> <span class="n">id2label</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">image_cl_dict</span><span class="p">[</span><span class="s">"labels"</span><span class="p">])]</span>
            
            <span class="n">cls_folder</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset_save_folder</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cls_folder</span><span class="p">):</span>
                <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">cls_folder</span><span class="p">)</span>
                
            <span class="n">image</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">cls_folder</span><span class="si">}</span><span class="s">/image_</span><span class="si">{</span><span class="n">image_idx</span><span class="si">}</span><span class="s">.jpg"</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>id2label: {0: 'PNEUMONIA', 1: 'NORMAL'}
DatasetDict({
    train: Dataset({
        features: ['image_file_path', 'image', 'labels'],
        num_rows: 12230
    })
    validation: Dataset({
        features: ['image_file_path', 'image', 'labels'],
        num_rows: 1165
    })
    test: Dataset({
        features: ['image_file_path', 'image', 'labels'],
        num_rows: 582
    })
})
</code></pre></div></div>

<p>Now, visualize the first sample of ChestXray dataset.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">example</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s">"train"</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"label: </span><span class="si">{</span><span class="n">example</span><span class="p">[</span><span class="s">'labels'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="n">example</span><span class="p">[</span><span class="s">"image"</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>label: 1
</code></pre></div></div>

<p><img src="../assets/blog/fiftyone_chestxray_example.jpg" alt="png" /></p>

<p>FiftyOne is an open-source toolkit for visualizing and curating datasets. In this stage, we will visualize all samples from the ChestXray dataset on the FiftyOne web UI.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span><span class="p">:</span>
    <span class="n">fo</span><span class="p">.</span><span class="n">delete_dataset</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="n">fiftyone_dataset</span> <span class="o">=</span> <span class="n">fo</span><span class="p">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">)</span>

<span class="n">dataset_type</span> <span class="o">=</span> <span class="n">fo</span><span class="p">.</span><span class="n">types</span><span class="p">.</span><span class="n">ImageClassificationDirectoryTree</span>

<span class="k">for</span> <span class="n">dataset_split</span> <span class="ow">in</span> <span class="n">dataset_splits</span><span class="p">:</span>
    <span class="n">dataset_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset_root</span><span class="p">,</span> <span class="n">dataset_split</span><span class="p">)</span>
    <span class="n">fiftyone_dataset</span><span class="p">.</span><span class="n">add_dir</span><span class="p">(</span>
        <span class="n">dataset_dir</span><span class="o">=</span><span class="n">dataset_dir</span><span class="p">,</span>
        <span class="n">dataset_type</span><span class="o">=</span><span class="n">dataset_type</span><span class="p">,</span>
        <span class="n">tags</span><span class="o">=</span><span class="n">dataset_split</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 100% |█████████████| 12230/12230 [3.8s elapsed, 0s remaining, 3.4K samples/s]      
 100% |███████████████| 1165/1165 [335.1ms elapsed, 0s remaining, 3.5K samples/s]      
 100% |█████████████████| 582/582 [179.4ms elapsed, 0s remaining, 3.2K samples/s]     
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">session</span> <span class="o">=</span> <span class="n">fo</span><span class="p">.</span><span class="n">launch_app</span><span class="p">(</span><span class="n">fiftyone_dataset</span><span class="p">)</span>
</code></pre></div></div>

<p>Now, we will define and load the preprocessor and the model. Here, we will utilize the Dinov2-base model from Meta.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoImageProcessor</span><span class="p">,</span> <span class="n">AutoModelForImageClassification</span>
<span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">load_dataset</span>

<span class="n">model_name</span> <span class="o">=</span> <span class="s">"facebook/dinov2-base"</span>
<span class="n">processor</span> <span class="o">=</span> <span class="n">AutoImageProcessor</span><span class="p">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">processor</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>BitImageProcessor {
  "crop_size": {
    "height": 224,
    "width": 224
  },
  "do_center_crop": true,
  "do_convert_rgb": true,
  "do_normalize": true,
  "do_rescale": true,
  "do_resize": true,
  "image_mean": [
    0.485,
    0.456,
    0.406
  ],
  "image_processor_type": "BitImageProcessor",
  "image_std": [
    0.229,
    0.224,
    0.225
  ],
  "resample": 3,
  "rescale_factor": 0.00392156862745098,
  "size": {
    "shortest_edge": 256
  }
}
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForImageClassification</span><span class="p">.</span><span class="n">from_pretrained</span><span class="p">(</span>
    <span class="n">model_name</span><span class="p">,</span>
    <span class="n">num_labels</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span>
    <span class="n">id2label</span><span class="o">=</span><span class="n">id2label</span><span class="p">,</span>
    <span class="n">label2id</span><span class="o">=</span><span class="n">label2id</span>
<span class="p">)</span>
</code></pre></div></div>

<p>To obtain a robust model, we will apply some augmentations to the training dataset.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">torchvision.transforms</span> <span class="kn">import</span> <span class="n">Compose</span><span class="p">,</span> <span class="n">RandomResizedCrop</span><span class="p">,</span> <span class="n">RandomHorizontalFlip</span><span class="p">,</span> <span class="n">ColorJitter</span><span class="p">,</span> <span class="n">ToTensor</span><span class="p">,</span> <span class="n">Normalize</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="c1"># Extarct image mean, std and interpolation from the inference processor
</span><span class="n">mean</span> <span class="o">=</span> <span class="n">processor</span><span class="p">.</span><span class="n">image_mean</span>
<span class="n">std</span> <span class="o">=</span> <span class="n">processor</span><span class="p">.</span><span class="n">image_std</span>
<span class="n">interpolation</span> <span class="o">=</span> <span class="n">processor</span><span class="p">.</span><span class="n">resample</span>

<span class="n">train_transform</span> <span class="o">=</span> <span class="n">Compose</span><span class="p">([</span>
    <span class="n">RandomResizedCrop</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="p">(</span><span class="mf">0.08</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">ratio</span><span class="o">=</span><span class="p">(</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">1.3333</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">),</span>
    <span class="n">RandomHorizontalFlip</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
    <span class="n">ColorJitter</span><span class="p">(</span><span class="n">brightness</span><span class="o">=</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">),</span> <span class="n">contrast</span><span class="o">=</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">),</span> <span class="n">saturation</span><span class="o">=</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">)),</span>
    <span class="n">ToTensor</span><span class="p">(),</span>
    <span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">std</span><span class="p">),</span>
<span class="p">])</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">prepare_data</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">"train"</span><span class="p">):</span>
  <span class="n">images</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s">"image"</span><span class="p">]</span>

  <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">"train"</span><span class="p">:</span>
    <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">train_transform</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">convert</span><span class="p">(</span><span class="s">"RGB"</span><span class="p">))</span> <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]</span>
    <span class="n">pixel_values</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">stack</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">"test"</span><span class="p">:</span>
    <span class="n">pixel_values</span> <span class="o">=</span> <span class="n">processor</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s">"pt"</span><span class="p">).</span><span class="n">pixel_values</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">"Mode </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s"> not supported"</span><span class="p">)</span>

  <span class="n">inputs</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">inputs</span><span class="p">[</span><span class="s">"pixel_values"</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixel_values</span>
  <span class="n">inputs</span><span class="p">[</span><span class="s">"labels"</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s">"labels"</span><span class="p">])</span>

  <span class="k">return</span> <span class="n">inputs</span>

<span class="c1"># set num_proc equal to the number of CPU cores on your machine
</span><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s">"train"</span><span class="p">].</span><span class="nb">map</span><span class="p">(</span><span class="n">prepare_data</span><span class="p">,</span> <span class="n">num_proc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">batched</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">fn_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s">"mode"</span><span class="p">:</span><span class="s">"train"</span><span class="p">})</span>
<span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s">"test"</span><span class="p">].</span><span class="nb">map</span><span class="p">(</span><span class="n">prepare_data</span><span class="p">,</span> <span class="n">num_proc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">batched</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">fn_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s">"mode"</span><span class="p">:</span><span class="s">"test"</span><span class="p">})</span>
</code></pre></div></div>

<p>Make the dataset suitable for Pytorch.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train_dataset</span><span class="p">.</span><span class="n">set_format</span><span class="p">(</span><span class="s">"torch"</span><span class="p">)</span>
<span class="n">eval_dataset</span><span class="p">.</span><span class="n">set_format</span><span class="p">(</span><span class="s">"torch"</span><span class="p">)</span>
</code></pre></div></div>

<p>Here, collate_fn is used for batching examples.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">torch</span>

<span class="k">def</span> <span class="nf">collate_fn</span><span class="p">(</span><span class="n">examples</span><span class="p">):</span>
    <span class="n">pixel_values</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">stack</span><span class="p">([</span><span class="n">example</span><span class="p">[</span><span class="s">"pixel_values"</span><span class="p">]</span> <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">])</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">example</span><span class="p">[</span><span class="s">"labels"</span><span class="p">]</span> <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">"pixel_values"</span><span class="p">:</span> <span class="n">pixel_values</span><span class="p">,</span> <span class="s">"labels"</span><span class="p">:</span> <span class="n">labels</span><span class="p">}</span>
</code></pre></div></div>

<h2 id="training-the-model">Training the Model</h2>

<p>In this stage, we will define training arguments and evaluation metrics.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">TrainingArguments</span>

<span class="n">training_args</span> <span class="o">=</span> <span class="n">TrainingArguments</span><span class="p">(</span>
    <span class="n">output_dir</span><span class="o">=</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s">"</span><span class="p">,</span>
    <span class="n">per_device_train_batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
    <span class="n">evaluation_strategy</span><span class="o">=</span><span class="s">"steps"</span><span class="p">,</span>
    <span class="n">num_train_epochs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">fp16</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">save_steps</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">eval_steps</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">logging_steps</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">5e-5</span><span class="p">,</span>
    <span class="n">save_total_limit</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">remove_unused_columns</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">push_to_hub</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">report_to</span><span class="o">=</span><span class="s">'tensorboard'</span><span class="p">,</span>
    <span class="n">load_best_model_at_end</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">metric_for_best_model</span><span class="o">=</span><span class="s">"accuracy"</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="k">def</span> <span class="nf">compute_metrics</span><span class="p">(</span><span class="n">eval_pred</span><span class="p">):</span>
    <span class="s">"""Computes accuracy on a batch of predictions"""</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">eval_pred</span><span class="p">.</span><span class="n">predictions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_pred</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span> <span class="n">y_true</span><span class="o">=</span><span class="n">eval_pred</span><span class="p">.</span><span class="n">label_ids</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">"accuracy"</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">}</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">Trainer</span>

<span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">training_args</span><span class="p">,</span>
    <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
    <span class="n">eval_dataset</span><span class="o">=</span><span class="n">eval_dataset</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="o">=</span><span class="n">processor</span><span class="p">,</span>
    <span class="n">compute_metrics</span><span class="o">=</span><span class="n">compute_metrics</span><span class="p">,</span>
    <span class="n">data_collator</span><span class="o">=</span><span class="n">collate_fn</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Now, we are ready to start finetuning our model.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train_results</span> <span class="o">=</span> <span class="n">trainer</span><span class="p">.</span><span class="n">train</span><span class="p">()</span>

<span class="n">trainer</span><span class="p">.</span><span class="n">save_model</span><span class="p">()</span>
<span class="n">trainer</span><span class="p">.</span><span class="n">log_metrics</span><span class="p">(</span><span class="s">"train"</span><span class="p">,</span> <span class="n">train_results</span><span class="p">.</span><span class="n">metrics</span><span class="p">)</span>
<span class="n">trainer</span><span class="p">.</span><span class="n">save_metrics</span><span class="p">(</span><span class="s">"train"</span><span class="p">,</span> <span class="n">train_results</span><span class="p">.</span><span class="n">metrics</span><span class="p">)</span>
<span class="n">trainer</span><span class="p">.</span><span class="n">save_state</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>***** train metrics *****
  epoch                    =          4.0
  total_flos               = 3562792493GF
  train_loss               =       0.2489
  train_runtime            =   0:22:04.82
  train_samples_per_second =       36.926
  train_steps_per_second   =        1.156
</code></pre></div></div>

<h2 id="evaluate-the-finetuned-model">Evaluate the Finetuned Model</h2>

<p>After training, evaluate the finetuned model.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">metrics</span> <span class="o">=</span> <span class="n">trainer</span><span class="p">.</span><span class="n">evaluate</span><span class="p">()</span>

<span class="n">trainer</span><span class="p">.</span><span class="n">log_metrics</span><span class="p">(</span><span class="s">"eval"</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span>
<span class="n">trainer</span><span class="p">.</span><span class="n">save_metrics</span><span class="p">(</span><span class="s">"eval"</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>***** eval metrics *****
  epoch                   =        4.0
  eval_accuracy           =     0.8282
  eval_loss               =     0.4037
  eval_runtime            = 0:00:09.98
  eval_samples_per_second =     58.267
  eval_steps_per_second   =      7.308
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoModelForImageClassification</span><span class="p">,</span> <span class="n">AutoImageProcessor</span>

<span class="n">finetuned_model_folder</span> <span class="o">=</span> <span class="s">"./facebook/dinov2-base"</span>

<span class="n">image_processor</span> <span class="o">=</span> <span class="n">AutoImageProcessor</span><span class="p">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">finetuned_model_folder</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForImageClassification</span><span class="p">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">finetuned_model_folder</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="k">def</span> <span class="nf">infer</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="c1"># prepare image for the model
</span>    <span class="n">encoding</span> <span class="o">=</span> <span class="n">image_processor</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">convert</span><span class="p">(</span><span class="s">"RGB"</span><span class="p">),</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s">"pt"</span><span class="p">)</span>
    
    <span class="c1"># forward pass
</span>    <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">encoding</span><span class="p">)</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">.</span><span class="n">logits</span>
        <span class="n">predicted_class_idx</span> <span class="o">=</span> <span class="n">logits</span><span class="p">.</span><span class="n">argmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="n">item</span><span class="p">()</span>
        <span class="n">predicted_class</span> <span class="o">=</span> <span class="n">id2label</span><span class="p">[</span><span class="n">predicted_class_idx</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">predicted_class</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fiftyone_test_dataset</span> <span class="o">=</span> <span class="n">fiftyone_dataset</span><span class="p">.</span><span class="n">match_tags</span><span class="p">(</span><span class="s">"test"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">fiftyone_test_dataset</span><span class="p">.</span><span class="n">iter_samples</span><span class="p">(</span><span class="n">autosave</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">image_path</span> <span class="o">=</span> <span class="n">sample</span><span class="p">.</span><span class="n">filepath</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
    <span class="n">predicted_class</span> <span class="o">=</span> <span class="n">infer</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">sample</span><span class="p">[</span><span class="s">"dinov2_prediction"</span><span class="p">]</span> <span class="o">=</span> <span class="n">fo</span><span class="p">.</span><span class="n">Classification</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">predicted_class</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 100% |█████████████████| 582/582 [1.3m elapsed, 0s remaining, 7.3 samples/s]      
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">session</span><span class="p">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">fiftyone_test_dataset</span>
</code></pre></div></div>

<p><img src="../assets/blog/fiftyone_chestxray_preds_gt.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">results</span> <span class="o">=</span> <span class="n">fiftyone_test_dataset</span><span class="p">.</span><span class="n">evaluate_classifications</span><span class="p">(</span>
    <span class="s">"dinov2_prediction"</span><span class="p">,</span>
    <span class="n">gt_field</span><span class="o">=</span><span class="s">"ground_truth"</span><span class="p">,</span>
    <span class="n">eval_key</span><span class="o">=</span><span class="s">"eval"</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s">"binary"</span><span class="p">,</span>
    <span class="n">classes</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">results</span><span class="p">.</span><span class="n">print_report</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>              precision    recall  f1-score   support

   PNEUMONIA       0.85      0.92      0.88       411
      NORMAL       0.76      0.61      0.68       171

    accuracy                           0.83       582
   macro avg       0.80      0.77      0.78       582
weighted avg       0.82      0.83      0.82       582
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plot</span> <span class="o">=</span> <span class="n">results</span><span class="p">.</span><span class="n">plot_confusion_matrix</span><span class="p">()</span>
<span class="n">plot</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plot</span> <span class="o">=</span> <span class="n">results</span><span class="p">.</span><span class="n">plot_pr_curve</span><span class="p">()</span>
<span class="n">plot</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="n">fiftyone_test_dataset</span><span class="p">.</span><span class="n">count_values</span><span class="p">(</span><span class="s">"eval"</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{'TP': 105, 'TN': 377, 'FP': 34, 'FN': 66}
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">fiftyone</span> <span class="kn">import</span> <span class="n">ViewField</span> <span class="k">as</span> <span class="n">F</span>

<span class="n">session</span><span class="p">.</span><span class="n">view</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">fiftyone_test_dataset</span>
    <span class="p">.</span><span class="n">match</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">"dinov2_prediction.label"</span><span class="p">)</span> <span class="o">!=</span> <span class="n">F</span><span class="p">(</span><span class="s">"ground_truth.label"</span><span class="p">))</span>
<span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">session</span><span class="p">.</span><span class="n">freeze</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="resources">Resources</h2>

<p>You can access the tutorial as a Jupyter Notebook on <a href="https://github.com/sefaburakokcu/notebooks/blob/main/fiftyone_finutene_dinov2_with_huggingface_for_chestxray.ipynb">FiftyOne Finetune DinoV2 with HuggingFace Transformers for ChestXray Dataset</a>.</p>




</div>
  </main>
  <footer class="mt-auto py-3 text-center">

  <small class="text-muted mb-2">
    <i class="fas fa-code"></i> with <i class="fas fa-heart"></i>
    by <strong>Sefa Burak OKCU</strong>
  </small>

  <div class="container-fluid justify-content-center"><a class="social mx-1"  href="mailto:sefaburak.okcu@gmail.com"
       style="color: #6c757d"
       onMouseOver="this.style.color='#db4437'"
       onMouseOut="this.style.color='#6c757d'">
      <i class="fas fa-envelope fa-1x"></i>
    </a><a class="social mx-1"  href="https://www.github.com/sefaburakokcu"
       style="color: #6c757d"
       onMouseOver="this.style.color='#333333'"
       onMouseOut="this.style.color='#6c757d'">
      <i class="fab fa-github fa-1x"></i>
    </a><a class="social mx-1"  href="https://www.linkedin.com/in/sefaburakokcu"
       style="color: #6c757d"
       onMouseOver="this.style.color='#007bb5'"
       onMouseOut="this.style.color='#6c757d'">
      <i class="fab fa-linkedin-in fa-1x"></i>
    </a><a class="social mx-1"  href="https://www.twitter.com/sefaburakokcu"
       style="color: #6c757d"
       onMouseOver="this.style.color='#1da1f2'"
       onMouseOut="this.style.color='#6c757d'">
      <i class="fab fa-twitter fa-1x"></i>
    </a>

</div><small id="attribution">
    theme <a href="https://github.com/YoussefRaafatNasry/portfolYOU">portfolYOU</a>
  </small>

</footer>

  
  <!-- GitHub Buttons -->
<script async defer src="https://buttons.github.io/buttons.js"></script>

<!-- jQuery CDN -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<!-- Popper.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"></script>

<!-- Bootstrap JS CDN -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

<!-- wow.js CDN & Activation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/wow/1.1.2/wow.js"></script>
<script> new WOW().init(); </script>

<!-- Initialize all tooltips -->
<script>
$(function () {
    $('[data-toggle="tooltip"]').tooltip()
})
</script>
</body>

</html>